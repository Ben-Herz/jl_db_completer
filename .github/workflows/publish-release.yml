name: "Step 2: Publish Release"
on:
  workflow_dispatch:
    inputs:
      branch:
        description: "The target branch"
        required: false
      release_url:
        description: "The URL of the draft GitHub release"
        required: false
      steps_to_skip:
        description: "Comma separated list of steps to skip"
        required: false

jobs:
  publish_release:
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: jupyterlab/maintainer-tools/.github/actions/base-setup@v1

      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Populate Release
        id: populate-release
        uses: jupyter-server/jupyter_releaser/.github/actions/populate-release@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          branch: ${{ github.event.inputs.branch }}
          release_url: ${{ github.event.inputs.release_url }}
          steps_to_skip: ${{ github.event.inputs.steps_to_skip }}

      - name: Download Python packages from release
        id: download
        run: |
          mkdir -p dist
          RELEASE_TAG=$(echo "${{ steps.populate-release.outputs.release_url }}" | sed 's|.*/tag/||')
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $RELEASE_TAG"

          # Download only .whl and .tar.gz files (Python packages), skip .tgz (npm)
          for asset in $(gh release view "$RELEASE_TAG" --json assets -q '.assets[].name'); do
            if [[ "$asset" == *.whl ]] || [[ "$asset" == *.tar.gz ]]; then
              echo "Downloading: $asset"
              gh release download "$RELEASE_TAG" --pattern "$asset" --dir dist
            else
              echo "Skipping: $asset (npm package)"
            fi
          done

          echo "Downloaded files:"
          ls -la dist/
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true

      - name: Publish GitHub Release
        run: |
          RELEASE_TAG="${{ steps.download.outputs.release_tag }}"
          gh release edit "$RELEASE_TAG" --draft=false
          echo "## Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/$RELEASE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI**: https://pypi.org/project/jl-db-comp/" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: "** Success **"
        if: ${{ success() }}
        run: |
          echo "Release published successfully!"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ steps.download.outputs.release_tag }}"

      - name: "** Failure Message **"
        if: ${{ failure() }}
        run: |
          echo "Failed to publish release"
          echo "Draft release URL: ${{ steps.populate-release.outputs.release_url }}"
